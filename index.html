<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QR Logger — v5.2 (PWA + Remote + ROI + Torch + Overlay)</title>
  <meta name="theme-color" content="#0f172a"/>
  <meta name="color-scheme" content="dark light"/>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="icons/icon-192.png"/>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e2e8f0;--accent:#22c55e;--border:#1f2937;--radius:16px}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, #0c152a, var(--bg) 40%);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.85);-webkit-backdrop-filter: blur(8px);
    backdrop-filter: blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0}.subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}@media(min-width:980px){.grid{grid-template-columns:420px 1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius)}
    .card .content{padding:16px}
    .video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000}
    video{width:100%;display:block;transform:scaleX(1)}
    .frame{position:absolute;inset:0;border:2px dashed rgba(255,255,255,.25);border-radius:12px;pointer-events:none}
    .controls{display:flex;gap:8px;flex-wrap:wrap}.controls>*{flex:1 1 auto}
    button,select,input,textarea{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1f7a3b,#14532d);border-color:#134e4a}
    button.secondary{background:linear-gradient(180deg,#0b2a64,#0b1f3a);border-color:#0b1f3a}
    .status{font-size:12px;color:var(--muted);margin-top:8px;min-height:18px}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#0b2a64;border:1px solid #0b1f3a;color:#cfe1ff}
    .banner{margin:12px 0;padding:10px 12px;border-radius:12px;border:1px solid #43320b;background:linear-gradient(180deg,rgba(255,170,0,.12),rgba(255,170,0,.06));color:#ffdd9a}
    table{width:100%;border-collapse:collapse}thead th{position:sticky;top:0;background:#0e172a;border-bottom:1px solid var(--border);font-size:12px;letter-spacing:.06em;color:#93a3b8;padding:10px 8px;text-align:left}
    tbody td{border-bottom:1px solid var(--border);padding:8px;vertical-align:top;font-size:14px}
    .note-cell[contenteditable="true"]{outline:1px dashed rgba(255,255,255,.15)}.count{display:inline-flex;gap:6px;background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25);border-radius:8px;padding:2px 8px;font-size:12px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1px,1px);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h1>QR Logger</h1>
        <div class="subtitle">v5.2 — PWA • Two‑Device Remote • ROI/Overlay • Torch • Zoom • A11y</div>
      </div>
      <div style="display:flex;gap:8px;min-width:320px">
        <button id="installBtn" class="secondary" style="display:none" type="button">Install App</button>
        <button id="remoteToggle" class="secondary" type="button">Remote Mode</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="androidBanner" class="banner" style="display:none"></div>

    <div class="grid" role="region" aria-label="QR scanner and log">
      <section class="card"><div class="content">
        <h2 style="margin:0 0 10px 0">Scanner</h2>
        <div class="video-wrap">
          <video id="video" playsinline webkit-playsinline muted></video>
          <canvas id="canvas" style="display:none"></canvas>
          <canvas id="overlay" style="position:absolute;inset:0;pointer-events:none"></canvas>
          <div class="frame" aria-hidden="true"></div>
        </div>
        <div class="controls" style="margin-top:12px">
          <button id="permBtn" class="secondary" type="button">Request Permission</button>
          <button id="startBtn" class="primary" type="button">Start Camera</button>
          <button id="stopBtn" class="secondary" type="button">Stop</button>
        </div>
        <div class="controls" style="margin-top:8px">
          <label class="sr-only" for="cameraSelect">Camera</label>
          <select id="cameraSelect" title="Camera" aria-label="Camera device list"></select>
          <button id="refreshBtn" class="secondary" title="Refresh camera list" type="button">Refresh Cameras</button>
          <label class="sr-only" for="prefFacing">Preferred camera</label>
          <select id="prefFacing" title="Preferred camera" aria-label="Preferred camera">
            <option value="environment">Prefer Back</option>
            <option value="user">Prefer Front</option>
            <option value="auto" selected>Auto</option>
          </select>
          <label class="sr-only" for="roi">Scan area</label>
          <select id="roi" title="Scan area" aria-label="Scan area">
            <option value="center" selected>Center square</option>
            <option value="full">Full frame</option>
          </select>
          <span id="scanEngine" class="pill" aria-live="polite">Engine: Detecting…</span>
        </div>
        <div class="controls" style="margin-top:8px">
          <button id="torchBtn" class="secondary" type="button">Torch</button>
          <button id="zoomIn" class="secondary" type="button">Zoom +</button>
          <button id="zoomOut" class="secondary" type="button">Zoom −</button>
          <button id="flipBtn" class="secondary" type="button">Flip (mirror)</button>
        </div>
        <div class="controls" style="margin-top:8px">
          <label class="sr-only" for="manualInput">Manual QR entry</label>
          <input id="manualInput" type="text" placeholder="Manual or keyboard scanner input (press Enter)"/>
          <button id="addManualBtn" type="button">Add</button>
        </div>
        <div id="status" class="status" role="status" aria-live="polite"></div>
        <div id="permState" class="muted" style="margin-top:6px"></div>
      </div></section>

      <section class="card"><div class="content">
        <h2 style="margin:0 0 10px 0">Log</h2>
        <div class="controls" style="margin-bottom:8px">
          <button id="exportXlsx" class="primary" type="button">Export Excel (.xlsx)</button>
          <button id="exportCsv" class="secondary" type="button">Export CSV</button>
          <button id="importFileBtn" class="secondary" aria-controls="fileInput" type="button">Import</button>
          <label for="fileInput" class="sr-only">Choose file to import</label>
          <input id="fileInput" type="file" accept=".csv, .xlsx, .xls" title="Choose file" aria-label="Choose file" style="display:none"/>
          <button id="clearBtn" class="secondary" title="Clear all rows" type="button">Clear</button>
        </div>
        <div class="card" style="max-height:55vh;overflow:auto">
          <table id="logTable">
            <thead><tr>
              <th>#</th><th>QR Content</th><th>Format</th><th>Source</th><th>Timestamp</th><th>Count</th><th>Notes (editable)</th><th>Actions</th>
            </tr></thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div></section>
    </div>

    <section id="remotePanel" class="card" style="margin-top:16px;display:none"><div class="content">
      <h2 style="margin:0 0 10px 0">Remote Mode</h2>
      <p class="muted">Phone scans → PC logs. Connect with Offer/Answer, QR, or 6‑digit code (if Firebase configured).</p>
      <div class="controls" style="margin-bottom:8px">
        <label class="sr-only" for="role">Role</label>
        <select id="role" title="Role" aria-label="Select role">
          <option value="host" selected>Host (PC)</option>
          <option value="camera">Camera (phone)</option>
        </select>
        <button id="startRole" class="primary" type="button">Start</button>
        <span id="remoteStatus" class="muted" aria-live="polite"></span>
      </div>

      <div id="hostUI" style="display:none">
        <h3>Host — Create Offer</h3>
        <div style="display:flex;gap:8px"><button id="createOffer" class="secondary" type="button">Create Offer</button><button id="copyOffer" class="secondary" type="button">Copy</button></div>
        <label class="sr-only" for="offerText">Offer</label>
        <textarea id="offerText" rows="5" placeholder="Offer will appear here"></textarea>
        <canvas id="offerQR" width="256" height="256" style="background:#fff;border-radius:10px;margin-top:8px" aria-label="Offer QR"></canvas>
        <h3 style="margin-top:12px">Paste Answer</h3>
        <div><button id="applyAnswer" class="secondary" type="button">Apply Answer</button></div>
        <label class="sr-only" for="answerText">Answer</label>
        <textarea id="answerText" rows="5" placeholder="Paste the answer from the phone"></textarea>
      </div>

      <div id="cameraUI" style="display:none">
        <h3>Camera — Enter/Scan Offer</h3>
        <div style="display:flex;gap:8px"><button id="scanOffer" class="secondary" type="button">Scan Offer QR</button><button id="applyOffer" class="secondary" type="button">Apply Offer</button></div>
        <label class="sr-only" for="offerInput">Offer from host</label>
        <textarea id="offerInput" rows="5" placeholder="Paste or scan the host offer"></textarea>
        <h3 style="margin-top:12px">Send Answer</h3>
        <div><button id="copyAnswerCam" class="secondary" type="button">Copy</button></div>
        <label class="sr-only" for="answerOut">Answer from phone</label>
        <textarea id="answerOut" rows="5" placeholder="Answer will appear here"></textarea>
        <canvas id="answerQR" width="256" height="256" style="background:#fff;border-radius:10px;margin-top:8px" aria-label="Answer QR"></canvas>
      </div>

      <div class="card" style="margin-top:12px"><div class="content">
        <h3 style="margin:0 0 8px 0">Pair by Code (Firestore)</h3>
        <div class="controls" style="margin-bottom:8px">
          <label class="sr-only" for="pairCode">6‑digit code</label>
          <input id="pairCode" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="6‑digit code"/>
          <button id="codeGenerate" class="secondary" type="button">Generate (Host)</button>
          <button id="codeJoin" class="secondary" type="button">Join (Camera)</button>
        </div>
        <div class="muted" id="codeStatus" aria-live="polite"></div>
      </div></div>
    </section>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- Optional Firebase (only used if FIREBASE_CONFIG exists) -->
  <script src="pairing-config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  if ('serviceWorker' in navigator) { try { navigator.serviceWorker.register('sw.js'); } catch(e){} }
  var deferredPrompt; var installBtn=document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt', function(e){
    e.preventDefault();
    deferredPrompt = e;
    if (installBtn) installBtn.style.display = 'inline-block';
  });
  if (installBtn) {
    installBtn.addEventListener('click', async function(){
      if (!deferredPrompt) return;
      try {
        const res = await deferredPrompt.prompt();
      } catch(e) {}
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });
  }
  }

  (function(){
    var $ = function(s){ return document.querySelector(s); };
    var video=$('#video'), canvas=$('#canvas'), overlay=$('#overlay');
    var ctx=canvas.getContext('2d',{willReadFrequently:true});
    var octx=overlay.getContext('2d');
    var statusEl=$('#status'), cameraSelect=$('#cameraSelect'), prefFacing=$('#prefFacing'), roiSel=$('#roi');
    var scanEnginePill=$('#scanEngine'), permStateEl=$('#permState'), androidBanner=$('#androidBanner');

    var stream=null, scanning=false, detector=null, usingBarcodeDetector=false, scanRAF=0; var data=[]; var STORAGE_KEY='qrLoggerV1';
    var mirrored=false; var pc=null, dc=null, role='host'; var iceServers=[{urls:'stun:stun.l.google.com:19302'}];

    var isAndroid=/Android/i.test(navigator.userAgent); var isInApp=/FBAN|FBAV|Instagram|Line\/|WeChat|Twitter|Snapchat|DuckDuckGo/i.test(navigator.userAgent);
    function setStatus(t){ statusEl.textContent = t || ''; }
    function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){} }
    function load(){ try{ data = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ data=[]; } }

    function showAndroidBanner(){ if(!isAndroid) return; var host=location.hostname; var msg='<b>Android tip:</b> '; msg+=isInApp?'You appear to be in an in‑app browser. Use menu → <b>Open in Chrome</b>.':'If no prompt: tap ⓘ/🔒 → <b>Permissions</b> → <b>Camera → Allow</b>, then reload.'; msg+='<br/>System: Settings → Apps → <b>Chrome</b> → Permissions → Camera → Allow.'; msg+='<br/>Site reset: Chrome ⋮ → Settings → Site settings → All sites → <b>'+host+'</b> → Clear & reset.'; androidBanner.innerHTML=msg; androidBanner.style.display='block'; }

    async function updatePerm(){ permStateEl.textContent=''; if(!('permissions' in navigator)) return; try{ var st=await navigator.permissions.query({name:'camera'}); permStateEl.textContent='Permission: '+st.state; st.onchange=function(){ permStateEl.textContent='Permission: '+st.state; }; }catch(e){} }

    function decideFacing(){ var p=prefFacing.value; if(p==='environment') return {facingMode:{ideal:'environment'}}; if(p==='user') return {facingMode:{ideal:'user'}}; return isAndroid?{facingMode:{ideal:'environment'}}:{facingMode:{ideal:'user'}}; }

    async function enumerateCams(){ try{ var devs=await navigator.mediaDevices.enumerateDevices(); var cams=devs.filter(function(d){ return d.kind==='videoinput'; }); cameraSelect.innerHTML=''; if(!cams.length){ var o=document.createElement('option'); o.value=''; o.textContent='No cameras detected'; cameraSelect.appendChild(o); return cams; } cams.forEach(function(c,i){ var o=document.createElement('option'); o.value=c.deviceId||''; o.textContent=c.label||('Camera '+(i+1)); cameraSelect.appendChild(o); }); return cams; }catch(e){ setStatus('enumerateDevices failed: '+e.message); return []; } }

    async function requestPermission(){ try{ setStatus('Requesting camera permission…'); var s=await navigator.mediaDevices.getUserMedia({video:decideFacing(),audio:false}); s.getTracks().forEach(function(t){ t.stop(); }); setStatus('Permission granted.'); }catch(e){ setStatus('Permission request failed: '+(e.name||'')+' '+(e.message||e)); showAndroidBanner(); } await updatePerm(); if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){ await enumerateCams(); } }

    async function startFromSelection(){ var errors=[]; async function attempt(v){ try{ stop(); setStatus('Starting camera…'); var s=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1920},height:{ideal:1080},focusMode:'continuous',advanced:[{focusMode:'continuous'}],...v},audio:false}); stream=s; videoElOn(); return true; }catch(e){ errors.push(e.name+': '+e.message); return false; } } var id=cameraSelect.value; if(id && await attempt({deviceId:{exact:id}})) return true; if(await attempt(decideFacing())) return true; var opp=prefFacing.value==='user'?{facingMode:{ideal:'environment'}}:{facingMode:{ideal:'user'}}; if(await attempt(opp)) return true; if(await attempt(true)) return true; setStatus('Failed to start camera. '+errors.join(' | ')); showAndroidBanner(); return false; }

    function getTrack(){ if(!stream) return null; var tracks=stream.getVideoTracks(); return tracks && tracks[0] ? tracks[0] : null; }

    function videoElOn(){ video.srcObject=stream; video.play().then(function(){ var t=getTrack(); var s=t?t.getSettings():{}; setStatus('Camera started ('+(s.width||'?')+'×'+(s.height||'?')+')'); sizeOverlay(); if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){ enumerateCams(); } initScanner(); tryApplyDefaults(); }).catch(function(e){ setStatus('Video play failed: '+e.message); }); }

    function sizeOverlay(){ overlay.width=video.clientWidth; overlay.height=video.clientHeight; }
    window.addEventListener('resize', sizeOverlay);

    async function tryApplyDefaults(){ try{ var t=getTrack(); if(!t) return; var caps=t.getCapabilities ? t.getCapabilities() : {}; var cons={advanced:[]}; if(caps.focusMode && caps.focusMode.indexOf('continuous')>-1) cons.advanced.push({focusMode:'continuous'}); if(caps.exposureMode && caps.exposureMode.indexOf('continuous')>-1) cons.advanced.push({exposureMode:'continuous'}); if(cons.advanced.length) await t.applyConstraints(cons); }catch(e){} }

    function stop(){ cancelAnimationFrame(scanRAF); scanning=false; if(stream){ stream.getTracks().forEach(function(t){ t.stop(); }); stream=null; } }

    async function initScanner(){ usingBarcodeDetector = ('BarcodeDetector' in window); if(usingBarcodeDetector){ try{ detector=new BarcodeDetector({formats:['qr_code','aztec','data_matrix','pdf417']}); scanEnginePill.textContent='Engine: BarcodeDetector'; scanning=true; return scanLoopDetector(); }catch(e){ usingBarcodeDetector=false; } } scanEnginePill.textContent='Engine: jsQR'; scanning=true; scanLoopJsQR(); }

    function drawOverlayBox(points){ if(!points || points.length<4) return; octx.clearRect(0,0,overlay.width,overlay.height); octx.lineWidth=4; octx.strokeStyle='#22c55e'; octx.beginPath(); octx.moveTo(points[0].x, points[0].y); for(var i=1;i<points.length;i++){ octx.lineTo(points[i].x, points[i].y); } octx.closePath(); octx.stroke(); }
    function clearOverlay(){ octx.clearRect(0,0,overlay.width,overlay.height); }

    async function scanLoopDetector(){ if(!scanning || !video || video.readyState<2){ scanRAF=requestAnimationFrame(scanLoopDetector); return; } try{ var det=null; try{ det=await detector.detect(video); }catch(e){ try{ var bmp=await createImageBitmap(video); det=await detector.detect(bmp); }catch(e2){} } if(det && det.length){ var c=det[0]; var text=c.rawValue || ''; upsert(text, c.format||'qr_code', 'camera'); if(c.cornerPoints){ drawOverlayBox(c.cornerPoints); } else if(c.corners){ drawOverlayBox(c.corners); } setTimeout(function(){ clearOverlay(); scanRAF=requestAnimationFrame(scanLoopDetector); }, 350); return; } }catch(e){} scanRAF=requestAnimationFrame(scanLoopDetector); }

    function scanLoopJsQR(){ if(!scanning || !video || video.readyState<2){ scanRAF=requestAnimationFrame(scanLoopJsQR); return; } var w=video.videoWidth||0, h=video.videoHeight||0; if(!w||!h){ scanRAF=requestAnimationFrame(scanLoopJsQR); return; } var useCenter = (roiSel && roiSel.value==='center'); var size = useCenter ? Math.min(w,h) : w; var sx = useCenter ? Math.floor((w-size)/2) : 0; var sy = useCenter ? Math.floor((h-size)/2) : 0; canvas.width=size; canvas.height=size; if(mirrored){ ctx.save(); ctx.scale(-1,1); ctx.drawImage(video, sx, sy, size, size, -size, 0, size, size); ctx.restore(); } else { ctx.drawImage(video, sx, sy, size, size, 0, 0, size, size); }
      try{ var id=ctx.getImageData(0,0,size,size); var q=jsQR(id.data,size,size,{ inversionAttempts:'attemptBoth' }); if(q && q.data){ upsert(q.data,'qr_code','camera'); var pts=[q.location.topLeftCorner,q.location.topRightCorner,q.location.bottomRightCorner,q.location.bottomLeftCorner].map(function(p){ return {x:p.x*(overlay.width/size), y:p.y*(overlay.height/size)}; }); drawOverlayBox(pts); setTimeout(function(){ clearOverlay(); scanRAF=requestAnimationFrame(scanLoopJsQR); }, 350); return; } }catch(e){} scanRAF=requestAnimationFrame(scanLoopJsQR); }

    var tbody=$('#logBody'); function render(){ tbody.innerHTML=''; for(var i=0;i<data.length;i++){ var r=data[i]; var tr=document.createElement('tr'); tr.innerHTML='<td class="muted">'+(i+1)+'</td><td>'+esc(r.content)+'</td><td><span class="pill">'+(r.format||'QR')+'</span></td><td class="muted">'+(r.source||'camera')+'</td><td class="muted">'+new Date(r.timestamp).toLocaleString()+'</td><td><span class="count">× '+(r.count||1)+'</span></td><td class="note-cell" contenteditable="true">'+esc(r.notes||'')+'</td><td><button class="small" data-act="edit" type="button">Edit</button> <button class="small" data-act="delete" type="button">Delete</button></td>'; tr.dataset.id=r.id; tbody.appendChild(tr); } }
    function esc(s){ s = (s==null)? '' : s; return (''+s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function upsert(content,format,source){ if(!format) format='qr_code'; if(!source) source='camera'; if(!content) return; var now=new Date().toISOString(); var ex=null; for(var i=0;i<data.length;i++){ if(data[i].content===content){ ex=data[i]; break; } } if(ex){ ex.count=(ex.count||1)+1; ex.timestamp=now; setStatus('Scanned: '+content); save(); render(); beep(); return; } data.unshift({id:(crypto.randomUUID?crypto.randomUUID():(Date.now()+Math.random().toString(36).slice(2))), content:content, format:format, source:source, timestamp:now, count:1, notes:''}); setStatus('Scanned: '+content); save(); render(); beep(); if(role==='camera' && dc && dc.readyState==='open'){ try{ dc.send(JSON.stringify({type:'qr', content:content, format:format, source:'remote-camera'})); }catch(e){} } }

    document.addEventListener('click', function(e){ var btn=e.target; while(btn && btn.tagName!=='BUTTON'){ btn = btn.parentNode; } if(!btn) return; var tr=e.target; while(tr && tr.tagName!=='TR'){ tr = tr.parentNode; } var id=(tr && tr.dataset)? tr.dataset.id : null; var act=btn.getAttribute('data-act'); if(act==='delete' && id){ data = data.filter(function(r){ return r.id!==id; }); save(); render(); } if(act==='edit' && id){ var row=null; for(var i=0;i<data.length;i++){ if(data[i].id===id){ row=data[i]; break; } } var nv=prompt('Edit QR content:', row?row.content:''); if(nv!==null && row){ row.content=nv; save(); render(); } } });
    document.addEventListener('blur', function(e){ var c=e.target; if(!c.classList || !c.classList.contains('note-cell')) return; var tr=c; while(tr && tr.tagName!=='TR'){ tr = tr.parentNode; } var id=(tr && tr.dataset)? tr.dataset.id : null; var row=null; for(var i=0;i<data.length;i++){ if(data[i].id===id){ row=data[i]; break; } } if(row){ row.notes=c.textContent; save(); } }, true);

    var manualInput=$('#manualInput'); document.getElementById('addManualBtn').addEventListener('click', function(){ var v=manualInput && manualInput.value ? manualInput.value.trim() : ''; if(v) { upsert(v,'text','manual/keyboard'); manualInput.value=''; } }); if(manualInput){ manualInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); var v=manualInput.value.trim(); if(v){ upsert(v,'text','manual/keyboard'); manualInput.value=''; } } }); }

    document.getElementById('exportCsv').addEventListener('click', function(){ var rows=[["QR Content","Format","Source","Timestamp","Count","Notes"]].concat(data.map(function(r){ return [r.content,r.format,r.source,r.timestamp,r.count,r.notes||'']; })); var csv=rows.map(function(r){ return r.map(function(f){ var s=((f==null)?'':f).toString().replace(/\\"/g,'\\"').replace(/\"/g,'\"\"'); return /[\",\\n]/.test(s)?('\"'+s+'\"'):s; }).join(','); }).join('\\n'); var blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='qr-log-'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+'.csv'; a.click(); URL.revokeObjectURL(a.href); });
    document.getElementById('exportXlsx').addEventListener('click', function(){ var ws=XLSX.utils.json_to_sheet(data.map(function(r){ return {"QR Content":r.content,"Format":r.format,"Source":r.source,"Timestamp":r.timestamp,"Count":r.count,"Notes":r.notes||''}; })); var wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'QR Log'); XLSX.writeFile(wb,'qr-log-'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+'.xlsx'); });
    document.getElementById('importFileBtn').addEventListener('click', function(){ var fi=document.getElementById('fileInput'); if(fi) fi.click(); });
    document.getElementById('fileInput').addEventListener('change', async function(e){ var file=e.target.files[0]; if(!file) return; var name=(file.name||'').toLowerCase(); if(name.slice(-4)==='.csv'){ var text=await file.text(); var rows=text.split(/\\r?\\n/).map(function(r){ return r.split(/,(?=(?:[^\\\"]*\\\"[^\\\"]*\\\")*[^\\\"]*$)/); }); var b=rows.slice(1); for(var i=0;i<b.length;i++){ var cols=b[i]; if(!cols.length||!cols[0])continue; upsert(cols[0].replace(/\\\\\\\"/g,'\\\"'),'text','import'); var last=data[0]; last.timestamp=cols[3]||new Date().toISOString(); last.count=parseInt(cols[4]||'1',10); last.notes=(cols[5]||'').replace(/^\\\"|\\\"$/g,''); } } else { var buf=await file.arrayBuffer(); var wb=XLSX.read(buf,{type:'array'}); var ws=wb.Sheets[wb.SheetNames[0]]; var rows2=XLSX.utils.sheet_to_json(ws); for(var j=0;j<rows2.length;j++){ var o=rows2[j]; upsert(o['QR Content'], o['Format']||'qr_code','import'); var last2=data[0]; last2.timestamp=o['Timestamp']||new Date().toISOString(); last2.count=parseInt(o['Count']||'1',10); last2.notes=o['Notes']||''; } } save(); render(); setStatus('Imported data from file.'); e.target.value=''; });

    var remoteToggle=$('#remoteToggle'), remotePanel=$('#remotePanel'), roleSel=$('#role'), startRole=$('#startRole'), remoteStatus=$('#remoteStatus');
    var hostUI=$('#hostUI'), cameraUI=$('#cameraUI');
    var createOfferBtn=$('#createOffer'), copyOfferBtn=$('#copyOffer'), offerText=$('#offerText'), offerQR=$('#offerQR');
    var applyAnswerBtn=$('#applyAnswer'), answerText=$('#answerText');
    var scanOfferBtn=$('#scanOffer'), applyOfferBtn=$('#applyOffer'), offerInput=$('#offerInput');
    var copyAnswerCamBtn=$('#copyAnswerCam'), answerOut=$('#answerOut'), answerQR=$('#answerQR');

    function setRemoteStatus(t){ remoteStatus.textContent=t||''; }
    function encodeObj(obj){ try{ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }catch(e){ return ''; } }
    function decodeObj(str){ try{ return JSON.parse(decodeURIComponent(escape(atob((str||'').trim())))); }catch(e){ return null; } }

    if(remoteToggle){ remoteToggle.addEventListener('click', function(){ remotePanel.style.display = (remotePanel.style.display==='none'?'block':'none'); }); }
    roleSel && roleSel.addEventListener('change', function(){ role=roleSel.value; renderRole(); });
    function renderRole(){ if(!hostUI||!cameraUI) return; hostUI.style.display = (role==='host'?'block':'none'); cameraUI.style.display = (role==='camera'?'block':'none'); }
    renderRole();

    startRole && startRole.addEventListener('click', function(){ setupPeer(); setRemoteStatus('Ready. Follow the steps below.'); });

    function setupPeer(){ try{ if(pc) pc.close(); }catch(e){} pc=new RTCPeerConnection({iceServers:iceServers}); pc.oniceconnectionstatechange=function(){ setRemoteStatus('ICE: '+pc.iceConnectionState); };
      if(role==='host'){ dc=pc.createDataChannel('qrlog'); wireDC(dc); } else { pc.ondatachannel=function(ev){ dc=ev.channel; wireDC(dc); }; }
      pc.onicegatheringstatechange=function(){ if(pc.iceGatheringState==='complete'){ if(role==='host'){ tryRenderOffer(); } else { tryRenderAnswer(); } } };
    }

    function wireDC(ch){ ch.onopen=function(){ setRemoteStatus('Connected'); }; ch.onclose=function(){ setRemoteStatus('Disconnected'); }; ch.onmessage=function(ev){ try{ var msg=JSON.parse(ev.data); if(msg.type==='qr'){ upsert(msg.content, msg.format||'qr_remote', msg.source||'remote'); } }catch(e){} } }

    async function tryRenderOffer(){ if(!pc || !pc.localDescription) return; offerText.value = encodeObj(pc.localDescription); try{ var s=offerText.value; if(window.QRCode){ QRCode.toCanvas(offerQR, s.length>2950?s.slice(0,2950):s); } }catch(e){} }
    async function tryRenderAnswer(){ if(!pc || !pc.localDescription) return; answerOut.value = encodeObj(pc.localDescription); try{ var s=answerOut.value; if(window.QRCode){ QRCode.toCanvas(answerQR, s.length>2950?s.slice(0,2950):s); } }catch(e){} }

    createOfferBtn && createOfferBtn.addEventListener('click', async function(){ if(!pc) setupPeer(); var offer=await pc.createOffer(); await pc.setLocalDescription(offer); setRemoteStatus('Gathering ICE…'); });
    copyOfferBtn && copyOfferBtn.addEventListener('click', function(){ if(navigator.clipboard) navigator.clipboard.writeText(offerText.value); });

    applyAnswerBtn && applyAnswerBtn.addEventListener('click', async function(){ var obj=decodeObj(answerText.value); if(!obj){ alert('Bad answer'); return; } try{ await pc.setRemoteDescription(obj); setRemoteStatus('Answer applied. Connecting…'); }catch(e){ alert('Bad answer'); } });

    applyOfferBtn && applyOfferBtn.addEventListener('click', async function(){ if(!pc) setupPeer(); var obj=decodeObj(offerInput.value); if(!obj){ alert('Bad offer'); return; } try{ await pc.setRemoteDescription(obj); var ans=await pc.createAnswer(); await pc.setLocalDescription(ans); setRemoteStatus('Gathering ICE…'); }catch(e){ alert('Bad offer'); } });

    scanOfferBtn && scanOfferBtn.addEventListener('click', async function(){ try{ await requestPermission(); await startFromSelection(); setStatus('Point camera at the host Offer QR…'); var scanOnce=function(){ var w=video.videoWidth, h=video.videoHeight; if(!w||!h){ requestAnimationFrame(scanOnce); return; } canvas.width=w; canvas.height=h; ctx.drawImage(video,0,0,w,h); try{ var id=ctx.getImageData(0,0,w,h); var q=jsQR(id.data,w,h,{inversionAttempts:'dontInvert'}); if(q && q.data){ offerInput.value=q.data; stop(); setStatus('Offer QR captured. Tap Apply Offer.'); } }catch(e){} requestAnimationFrame(scanOnce); }; requestAnimationFrame(scanOnce); }catch(e){ alert('Unable to access camera to scan offer.'); } });
    copyAnswerCamBtn && copyAnswerCamBtn.addEventListener('click', function(){ if(navigator.clipboard) navigator.clipboard.writeText(answerOut.value); });

    var fb=null, db=null, codeDoc=null, codeUnsubs=[]; var codeInput=$('#pairCode'); var codeStatus=$('#codeStatus'); var codeGenerateBtn=$('#codeGenerate'); var codeJoinBtn=$('#codeJoin');
    function fbLog(t){ if(codeStatus) codeStatus.textContent=t||''; }
    function randCode(){ return ''+Math.floor(100000 + Math.random()*900000); }
    function initFirebase(){ try{ if(!window.FIREBASE_CONFIG || !window.firebase || fb) return false; fb=firebase.initializeApp(window.FIREBASE_CONFIG); db=firebase.firestore(); return true; }catch(e){ return false; } }
    async function cleanupCodeDoc(){ try{ codeUnsubs.forEach(function(u){ try{u&&u();}catch(e){} }); codeUnsubs=[]; if(codeDoc){ try{ await codeDoc.delete(); }catch(e){} codeDoc=null; } }catch(e){} }

    async function codeHostStart(){ if(!initFirebase()){ fbLog('Pairing not configured. Add pairing‑config.js'); return; } await cleanupCodeDoc(); var code=randCode(); if(codeInput) codeInput.value=code; codeDoc = db.collection('qrRooms').doc(code); await codeDoc.set({ created: firebase.firestore.FieldValue.serverTimestamp() }); var offer = await pc.createOffer({ offerToReceiveAudio:false, offerToReceiveVideo:false }); await pc.setLocalDescription(offer); await new Promise(function(res){ (function chk(){ if(pc.iceGatheringState==='complete') res(); else setTimeout(chk,50); })(); }); await codeDoc.set({ offer: pc.localDescription.toJSON(), created: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); fbLog('Share the 6‑digit code and wait for answer…'); codeUnsubs.push(codeDoc.onSnapshot(async function(snap){ var data=snap.data(); if(!data || !data.answer) return; try{ await pc.setRemoteDescription(new RTCSessionDescription(data.answer)); fbLog('Connected by code.'); setTimeout(function(){ cleanupCodeDoc(); }, 30000); }catch(e){ fbLog('Bad answer. Try again.'); } })); }

    async function codeCameraJoin(){ if(!initFirebase()){ fbLog('Pairing not configured. Add pairing‑config.js'); return; } var code=(codeInput && codeInput.value || '').trim(); if(!/^\\d{6}$/.test(code)){ fbLog('Enter a 6‑digit code.'); return; } codeDoc = db.collection('qrRooms').doc(code); var snap = await codeDoc.get(); var data=snap.data(); if(!data || !data.offer){ fbLog('No offer for this code yet.'); return; } try{ await pc.setRemoteDescription(new RTCSessionDescription(data.offer)); var answer = await pc.createAnswer(); await pc.setLocalDescription(answer); await new Promise(function(res){ (function chk(){ if(pc.iceGatheringState==='complete') res(); else setTimeout(chk,50); })(); }); await codeDoc.set({ answer: pc.localDescription.toJSON() }, { merge:true }); fbLog('Answer posted. Connecting…'); setTimeout(function(){ cleanupCodeDoc(); }, 30000); }catch(e){ fbLog('Failed to join with this code.'); }
    }

    codeGenerateBtn && codeGenerateBtn.addEventListener('click', function(){ if(!pc) setupPeer(); if(role!=='host'){ fbLog('Switch role to Host.'); return; } codeHostStart(); });
    codeJoinBtn && codeJoinBtn.addEventListener('click', function(){ if(!pc) setupPeer(); if(role!=='camera'){ fbLog('Switch role to Camera.'); return; } codeCameraJoin(); });

    var torchOn=false; async function toggleTorch(){ try{ var t=getTrack(); if(!t || !t.applyConstraints) return; var caps=t.getCapabilities? t.getCapabilities() : {}; if(!caps.torch){ setStatus('Torch not supported on this device.'); return; } torchOn=!torchOn; await t.applyConstraints({advanced:[{torch:torchOn}]}); setStatus('Torch '+(torchOn?'on':'off')); }catch(e){ setStatus('Torch failed: '+e.message); } }
    async function changeZoom(delta){ try{ var t=getTrack(); if(!t) return; var caps=t.getCapabilities? t.getCapabilities() : {}; if(!caps.zoom){ setStatus('Zoom not supported.'); return; } var s=t.getSettings? t.getSettings() : {}; var cur=typeof s.zoom==='number'? s.zoom : (caps.zoom.min||1); var next=Math.max(caps.zoom.min, Math.min(caps.zoom.max, cur + delta*(caps.zoom.step||0.1))); await t.applyConstraints({advanced:[{zoom:next}]}); setStatus('Zoom: '+(next.toFixed? next.toFixed(2) : next)); }catch(e){ setStatus('Zoom failed: '+e.message); } }

    document.getElementById('permBtn').addEventListener('click', requestPermission);
    document.getElementById('startBtn').addEventListener('click', startFromSelection);
    document.getElementById('stopBtn').addEventListener('click', function(){ stop(); setStatus('Camera stopped.'); clearOverlay(); });
    document.getElementById('refreshBtn').addEventListener('click', enumerateCams);
    document.getElementById('torchBtn').addEventListener('click', toggleTorch);
    document.getElementById('zoomIn').addEventListener('click', function(){ changeZoom(0.25); });
    document.getElementById('zoomOut').addEventListener('click', function(){ changeZoom(-0.25); });
    document.getElementById('flipBtn').addEventListener('click', function(){ mirrored=!mirrored; video.style.transform = mirrored ? 'scaleX(-1)' : 'scaleX(1)'; });
    document.getElementById('remoteToggle').addEventListener('click', function(){ var rp=document.getElementById('remotePanel'); rp.style.display = (rp.style.display==='none'?'block':'none'); });
    cameraSelect.addEventListener('change', startFromSelection);

    load(); render(); updatePerm(); if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){ enumerateCams(); } showAndroidBanner();
    if(document.visibilityState==='visible') setStatus('Ready. Request Permission → Start Camera.');
  })();

  function beep(){ try{ var a=new AudioContext(), o=a.createOscillator(), g=a.createGain(); o.type='square'; o.frequency.value=880; o.connect(g); g.connect(a.destination); g.gain.setValueAtTime(0.05,a.currentTime); o.start(); setTimeout(function(){o.stop(); a.close();},90);}catch(e){} }
  </script>
</body>
</html>
