<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>QR Logger â€” v5.3.5 (Start camera fix)</title>
  <meta name="theme-color" content="#0f172a"/>
  <meta name="color-scheme" content="dark light"/>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="icons/icon-192.png"/>
  <style>
    :root{--bg:#0b1220;--panel:#0f172a;--muted:#94a3b8;--text:#e2e8f0;--accent:#22c55e;--border:#1f2937;--radius:16px}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%, #0c152a, var(--bg) 40%);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(15,23,42,.85);-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0}.subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}@media(min-width:980px){.grid{grid-template-columns:460px 1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:var(--radius)}
    .card .content{padding:16px}
    .video-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000}
    video{width:100%;display:block}
    .frame{position:absolute;inset:0;border:2px dashed rgba(255,255,255,.25);border-radius:12px;pointer-events:none}
    .controls{display:flex;gap:8px;flex-wrap:wrap}.controls>*{flex:1 1 auto}
    button,select,input,textarea{background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1f7a3b,#14532d);border-color:#134e4a}
    button.secondary{background:linear-gradient(180deg,#0b2a64,#0b1f3a);border-color:#0b1f3a}
    .status{font-size:12px;color:var(--muted);margin-top:8px;min-height:18px}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#0b2a64;border:1px solid #0b1f3a;color:#cfe1ff}
    .banner{margin:12px 0;padding:10px 12px;border-radius:12px;border:1px solid #43320b;background:linear-gradient(180deg,rgba(255,170,0,.12),rgba(255,170,0,.06));color:#ffdd9a}
    table{width:100%;border-collapse:collapse}thead th{position:sticky;top:0;background:#0e172a;border-bottom:1px solid var(--border);font-size:12px;letter-spacing:.06em;color:#93a3b8;padding:10px 8px;text-align:left}
    tbody td{border-bottom:1px solid var(--border);padding:8px;vertical-align:top;font-size:14px}
    .note-cell[contenteditable=\"true\"]{outline:1px dashed rgba(255,255,255,.15)}.count{display:inline-flex;gap:6px;background:rgba(34,197,94,.12);color:#86efac;border:1px solid rgba(34,197,94,.25);border-radius:8px;padding:2px 8px;font-size:12px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,1px,1px);white-space:nowrap;border:0}
    .thumb{width:64px;height:auto;border-radius:6px;border:1px solid var(--border)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h1>QR Logger</h1>
        <div class="subtitle">v5.3.5 â€” Start camera fix, OCR toggle polish</div>
      </div>
      <div style="display:flex;gap:8px;min-width:320px">
        <button id="installBtn" type="button" class="secondary" style="display:none">Install App</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="androidBanner" class="banner" style="display:none"></div>

    <div class="grid">
      <section class="card"><div class="content">
        <h2 style="margin:0 0 10px 0">Scanner</h2>
        <div class="video-wrap">
          <video id="video" playsinline webkit-playsinline muted></video>
          <canvas id="canvas" style="display:none"></canvas>
          <canvas id="overlay" style="position:absolute;inset:0;pointer-events:none"></canvas>
          <div class="frame" aria-hidden="true"></div>
        </div>
        <div class="controls" style="margin-top:12px">
          <button id="permBtn" type="button" class="secondary">Request Permission</button>
          <button id="startBtn" type="button" class="primary">Start Camera</button>
          <button id="stopBtn" type="button" class="secondary">Stop</button>
        </div>
        <div class="controls" style="margin-top:8px">
          <label class="sr-only" for="cameraSelect">Camera</label>
          <select id="cameraSelect" title="Camera" aria-label="Camera device list"></select>
          <button id="refreshBtn" type="button" class="secondary" title="Refresh camera list">Refresh Cameras</button>
          <label class="sr-only" for="prefFacing">Preferred camera</label>
          <select id="prefFacing" title="Preferred camera" aria-label="Preferred camera">
            <option value="environment">Prefer Back</option>
            <option value="user">Prefer Front</option>
            <option value="auto" selected>Auto</option>
          </select>
          <span id="scanEngine" class="pill" aria-live="polite">Engine: Detectingâ€¦</span>
        </div>

        <div class="controls" style="margin-top:8px">
          <label class="sr-only" for="manualInput">Manual QR entry</label>
          <input id="manualInput" type="text" placeholder="Manual or keyboard scanner input (press Enter)"/>
          <button id="addManualBtn" type="button">Add</button>
        </div>

        <div class="controls" style="margin-top:8px">
          <label class="sr-only" for="scaleMode">Scale source</label>
          <select id="scaleMode" title="Scale source">
            <option value="none" selected>No scale</option>
            <option value="ocr">OCR from camera</option>
            <option value="hid">USB/HID scale</option>
            <option value="ble">Bluetooth scale</option>
          </select>
          <label class="sr-only" for="delaySec">Scale delay seconds</label>
          <input id="delaySec" type="number" min="0" max="4" step="0.1" value="2" title="Delay (seconds)"/>
          <button id="connectHID" type="button" class="secondary">Connect USB/HID</button>
          <button id="connectBLE" type="button" class="secondary">Connect BLE</button>
          <button id="ocrToggle" type="button" class="secondary">Toggle OCR Box</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>
        <div id="permState" class="muted" style="margin-top:6px"></div>
      </div></section>

      <section class="card"><div class="content">
        <h2 style="margin:0 0 10px 0">Log</h2>
        <div class="controls" style="margin-bottom:8px">
          <button id="exportXlsx" type="button" class="primary">Export Excel (.xlsx)</button>
          <button id="exportCsv" type="button" class="secondary">Export CSV</button>
          <button id="exportZip" type="button" class="secondary">Export ZIP (CSV+Photos)</button>
          <button id="importFileBtn" type="button" class="secondary" aria-controls="fileInput">Import</button>
          <label for="fileInput" class="sr-only">Choose file to import</label>
          <input id="fileInput" type="file" accept=".csv, .xlsx, .xls" title="Choose file" aria-label="Choose file" style="display:none"/>
          <button id="clearBtn" type="button" class="secondary" title="Clear all rows">Clear</button>
        </div>
        <div class="card" style="max-height:55vh;overflow:auto">
          <table id="logTable">
            <thead><tr>
              <th>#</th><th>QR Content</th><th>Format</th><th>Source</th><th>Date</th><th>Time</th><th>Weight</th><th>Photo</th><th>Count</th><th>Notes (editable)</th><th>Actions</th>
            </tr></thead>
            <tbody id="logBody"></tbody>
          </table>
        </div>
      </div></section>
    </div>
  </main>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <script>
  // PWA install
  if ('serviceWorker' in navigator) { try { navigator.serviceWorker.register('sw.js'); } catch(e){} }
  var deferredPrompt; var installBtn=document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt', function(e){ e.preventDefault(); deferredPrompt=e; if(installBtn) installBtn.style.display='inline-block'; });
  if(installBtn){ installBtn.addEventListener('click', function(){ if(!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt=null; installBtn.style.display='none'; }); }

  (function(){
    const $ = s => document.querySelector(s);
    const video = $('#video');
    const canvas = $('#canvas');
    const overlay = $('#overlay');
    const ctx = canvas.getContext('2d', { willReadFrequently:true });
    const octx = overlay.getContext('2d');
    const statusEl = $('#status');
    const cameraSelect = $('#cameraSelect');
    const prefFacing = $('#prefFacing');
    const scanEnginePill = $('#scanEngine');
    const permStateEl = $('#permState');
    const androidBanner = $('#androidBanner');

    const scaleModeSel = $('#scaleMode');
    const delayInput = $('#delaySec');
    const connectHIDBtn = $('#connectHID');
    const connectBLEBtn = $('#connectBLE');
    const ocrToggleBtn = $('#ocrToggle');

    let stream = null, scanning = false, detector = null, usingBarcodeDetector=false, scanRAF=0;
    let data = []; const STORAGE_KEY='qrLoggerV1';

    // scale & OCR state
    let scaleMode='none', delaySec=2, lastKnownWeight='', hidDevice=null, bleDevice=null, bleChar=null;
    let ocrBox={x:0.6,y:0.65,w:0.35,h:0.25}, ocrBoxEnabled=false, isDragging=false, dragOffset={x:0,y:0};

    const isAndroid=/Android/i.test(navigator.userAgent);
    const isInApp=/FBAN|FBAV|Instagram|Line\/|WeChat|Twitter|Snapchat|DuckDuckGo/i.test(navigator.userAgent);

    function setStatus(t){ statusEl.textContent = t || ''; }
    function save(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){} }
    function load(){ try{ data = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){ data=[]; } }

    function showAndroidBanner(){ if(!isAndroid) return; const host=location.hostname; let msg='<b>Android tip:</b> '; msg+=isInApp?'You appear to be in an inâ€‘app browser. Use menu â†’ <b>Open in Chrome</b>.':'If no prompt: tap â“˜/ðŸ”’ â†’ <b>Permissions</b> â†’ <b>Camera â†’ Allow</b>, then reload.'; msg+='<br/>System: Settings â†’ Apps â†’ <b>Chrome</b> â†’ Permissions â†’ Camera â†’ Allow.'; msg+='<br/>Site reset: Chrome â‹® â†’ Settings â†’ Site settings â†’ All sites â†’ <b>'+host+'</b> â†’ Clear & reset.'; androidBanner.innerHTML=msg; androidBanner.style.display='block'; }

    async function updatePerm(){ permStateEl.textContent=''; if(!('permissions' in navigator)) return; try{ const st=await navigator.permissions.query({name:'camera'}); permStateEl.textContent='Permission: '+st.state; st.onchange=()=>{ permStateEl.textContent='Permission: '+st.state; }; }catch(e){} }

    function decideFacing(){ const p=prefFacing.value; if(p==='environment') return {facingMode:{ideal:'environment'}}; if(p==='user') return {facingMode:{ideal:'user'}}; return isAndroid?{facingMode:{ideal:'environment'}}:{facingMode:{ideal:'user'}}; }

    async function enumerateCams(){ try{ const devs=await navigator.mediaDevices.enumerateDevices(); const cams=devs.filter(d=>d.kind==='videoinput'); cameraSelect.innerHTML=''; if(!cams.length){ const o=document.createElement('option'); o.value=''; o.textContent='No cameras detected'; cameraSelect.appendChild(o); return cams; } cams.forEach((c,i)=>{ const o=document.createElement('option'); o.value=c.deviceId||''; o.textContent=c.label||('Camera '+(i+1)); cameraSelect.appendChild(o); }); return cams; }catch(e){ setStatus('enumerateDevices failed: '+e.message); return []; } }

    async function requestPermission(){ try{ setStatus('Requesting camera permissionâ€¦'); const s=await navigator.mediaDevices.getUserMedia({video:decideFacing(),audio:false}); s.getTracks().forEach(t=>t.stop()); setStatus('Permission granted.'); }catch(e){ setStatus('Permission request failed: '+(e.name||'')+' '+(e.message||e)); showAndroidBanner(); } await updatePerm(); if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){ await enumerateCams(); } }

    async function startFromSelection(){
      let errors = [];
      async function attempt(v){
        try {
          stop();
          setStatus('Starting cameraâ€¦');
          const s = await navigator.mediaDevices.getUserMedia({
            video:{ width:{ideal:1920}, height:{ideal:1080}, focusMode:'continuous', advanced:[{focusMode:'continuous'}], ...v },
            audio:false
          });
          stream = s;
          videoElOn();
          return true;
        } catch(e) {
          errors.push(e.name + ': ' + e.message);
          return false;
        }
      }
      const id = cameraSelect.value;
      if (id && await attempt({deviceId:{exact:id}})) return true;
      if (await attempt(decideFacing())) return true;
      const opp = (prefFacing.value==='user') ? {facingMode:{ideal:'environment'}} : {facingMode:{ideal:'user'}};
      if (await attempt(opp)) return true;
      if (await attempt(true)) return true;
      setStatus('Failed to start camera. ' + errors.join(' | '));
      showAndroidBanner();
      return false;
    }

    function getTrack(){ if(!stream) return null; const tracks=stream.getVideoTracks(); return tracks && tracks[0] ? tracks[0] : null; }

    function videoElOn(){ video.srcObject=stream; video.play().then(()=>{ const t=getTrack(); const s=t?t.getSettings():{}; setStatus('Camera started ('+(s.width||'?')+'Ã—'+(s.height||'?')+')'); sizeOverlay(); if(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices){ enumerateCams(); } initScanner(); tryApplyDefaults(); }).catch(e=> setStatus('Video play failed: '+e.message)); }

    function sizeOverlay(){ overlay.width=video.clientWidth; overlay.height=video.clientHeight; drawOCRBox(); }
    window.addEventListener('resize', sizeOverlay);

    async function tryApplyDefaults(){ try{ const t=getTrack(); if(!t) return; const caps=t.getCapabilities ? t.getCapabilities() : {}; const cons={advanced:[]}; if(caps.focusMode && caps.focusMode.indexOf('continuous')>-1) cons.advanced.push({focusMode:'continuous'}); if(caps.exposureMode && caps.exposureMode.indexOf('continuous')>-1) cons.advanced.push({exposureMode:'continuous'}); if(cons.advanced.length) await t.applyConstraints(cons); }catch(e){} }

    function stop(){ cancelAnimationFrame(scanRAF); scanning=false; if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } if(octx){ octx.clearRect(0,0,overlay.width,overlay.height); } }

    async function initScanner(){ usingBarcodeDetector = ('BarcodeDetector' in window); if(usingBarcodeDetector){ try{ detector=new BarcodeDetector({formats:['qr_code','aztec','data_matrix','pdf417']}); scanEnginePill.textContent='Engine: BarcodeDetector'; scanning=true; return scanLoopDetector(); }catch(e){ usingBarcodeDetector=false; } } scanEnginePill.textContent='Engine: jsQR'; scanning=true; scanLoopJsQR(); }

    async function scanLoopDetector(){ if(!scanning || !video || video.readyState<2){ scanRAF=requestAnimationFrame(scanLoopDetector); return; } try{ let det=null; try{ det=await detector.detect(video); }catch(e){ try{ const bmp=await createImageBitmap(video); det=await detector.detect(bmp); }catch(e2){} } if(det && det.length){ const c=det[0]; const text=c.rawValue || ''; upsert(text, c.format||'qr_code', 'camera'); setTimeout(()=>{ scanRAF=requestAnimationFrame(scanLoopDetector); }, 350); return; } }catch(e){} scanRAF=requestAnimationFrame(scanLoopDetector); }

    function scanLoopJsQR(){ if(!scanning || !video || video.readyState<2){ scanRAF=requestAnimationFrame(scanLoopJsQR); return; } const w=video.videoWidth||0, h=video.videoHeight||0; if(!w||!h){ scanRAF=requestAnimationFrame(scanLoopJsQR); return; } canvas.width=w; canvas.height=h; ctx.drawImage(video,0,0,w,h); try{ const id=ctx.getImageData(0,0,w,h); const q=jsQR(id.data,w,h,{inversionAttempts:'attemptBoth'}); if(q && q.data){ upsert(q.data,'qr_code','camera'); setTimeout(()=>{ scanRAF=requestAnimationFrame(scanLoopJsQR); }, 350); return; } }catch(e){} scanRAF=requestAnimationFrame(scanLoopJsQR); }

    const tbody=$('#logBody'); function render(){ tbody.innerHTML=''; data.forEach((r,i)=>{ const tr=document.createElement('tr'); const dateStr=r.date||new Date(r.timestamp).toLocaleDateString(); const timeStr=r.time||new Date(r.timestamp).toLocaleTimeString(); const photoCell=r.photo?`<a href="${r.photo}" target="_blank" rel="noopener"><img class="thumb" src="${r.photo}" alt="photo"/></a>`:''; tr.innerHTML=`<td class="muted">${i+1}</td><td>${esc(r.content)}</td><td><span class="pill">${r.format||'QR'}</span></td><td class="muted">${r.source||'camera'}</td><td class="muted">${dateStr}</td><td class="muted">${timeStr}</td><td>${r.weight||''}</td><td>${photoCell}</td><td><span class="count">Ã— ${r.count||1}</span></td><td class="note-cell" contenteditable="true">${esc(r.notes||'')}</td><td><button type="button" class="small" data-act="edit">Edit</button> <button type="button" class="small" data-act="delete">Delete</button></td>`; tr.dataset.id=r.id; tbody.appendChild(tr); }); }
    function esc(s){ s = (s==null)? '' : s; return (''+s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function upsert(content,format='qr_code',source='camera'){ if(!content) return; const now=new Date(); const iso=now.toISOString(); const ex=data.find(x=>x.content===content); if(ex){ ex.count=(ex.count||1)+1; ex.timestamp=iso; ex.date=now.toLocaleDateString(); ex.time=now.toLocaleTimeString(); save(); render(); beep(); scheduleCapture(ex.id); return; } const row={id:(crypto.randomUUID?crypto.randomUUID():(Date.now()+Math.random().toString(36).slice(2))), content, format, source, timestamp: iso, date:now.toLocaleDateString(), time:now.toLocaleTimeString(), weight:'', photo:'', count:1, notes:''}; data.unshift(row); save(); render(); beep(); scheduleCapture(row.id); }

    document.addEventListener('click', function(e){ const btn=e.target.closest('button'); if(!btn) return; const tr=e.target.closest('tr'); const id=tr?.dataset?.id; const act=btn.getAttribute('data-act'); if(act==='delete' && id){ data = data.filter(r=>r.id!==id); save(); render(); } if(act==='edit' && id){ const row=data.find(r=>r.id===id); const nv=prompt('Edit QR content:', row?row.content:''); if(nv!==null && row){ row.content=nv; save(); render(); } } });
    document.addEventListener('blur', function(e){ const c=e.target; if(!c.classList || !c.classList.contains('note-cell')) return; const tr=c.closest('tr'); const id=tr?.dataset?.id; const row=data.find(r=>r.id===id); if(row){ row.notes=c.textContent; save(); } }, true);

    const manualInput=$('#manualInput'); document.getElementById('addManualBtn').addEventListener('click', function(){ const v=manualInput && manualInput.value ? manualInput.value.trim() : ''; if(v) { upsert(v,'text','manual/keyboard'); manualInput.value=''; } }); if(manualInput){ manualInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); const v=manualInput.value.trim(); if(v){ upsert(v,'text','manual/keyboard'); manualInput.value=''; } } }); }

    document.getElementById('exportCsv').addEventListener('click', function(){ const headers=["QR Content","Format","Source","Date","Time","Weight","Photo","Count","Notes","Timestamp"]; const rows=[headers, ...data.map(r=>[r.content,r.format,r.source,r.date||'',r.time||'',r.weight||'',r.photo||'',r.count,r.notes||'',r.timestamp||''])]; const csv=rows.map(row=>row.map(f=>{ const s=((f==null)?'':String(f)).replace(/\"/g,'\"\"'); return /[\",\n]/.test(s)?('\"'+s+'\"'):s; }).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='qr-log-'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+'.csv'; a.click(); URL.revokeObjectURL(a.href); });
    document.getElementById('exportXlsx').addEventListener('click', function(){ const ws=XLSX.utils.json_to_sheet(data.map(r=>({\"QR Content\":r.content,\"Format\":r.format,\"Source\":r.source,\"Date\":r.date||'',\"Time\":r.time||'',\"Weight\":r.weight||'',\"Photo\":r.photo||'',\"Count\":r.count,\"Notes\":r.notes||'',\"Timestamp\":r.timestamp||''}))); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'QR Log'); XLSX.writeFile(wb,'qr-log-'+new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')+'.xlsx'); });

    document.getElementById('exportZip').addEventListener('click', async function(){ try{ const zip=new JSZip(); const headers=["QR Content","Format","Source","Date","Time","Weight","Photo","Count","Notes","Timestamp"]; const rows=[headers, ...data.map((r,i)=>{ let photoName=''; if(r.photo && /^data:image\\//.test(r.photo)){ const m1=r.photo.match(/^data:(image\\/[^;]+)/); const mt=(m1 && m1[1]) ? m1[1] : 'image/jpeg'; const ext=mt.split('/')[1]; const safe=(r.content||'').toString().slice(0,20).replace(/[^a-z0-9\\-_]+/gi,'_'); photoName=`photos/${String(i+1).padStart(4,'0')}_${safe}.${ext}`; } return [r.content,r.format,r.source,r.date||'',r.time||'',r.weight||'',photoName,r.count,r.notes||'',r.timestamp||'']; })]; const csv=rows.map(row=>row.map(f=>{ const s=(f==null? '' : String(f)).replace(/\"/g,'\"\"'); return /[\",\n]/.test(s)?('\"'+s+'\"'):s; }).join(',')).join('\n'); const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); zip.file(`qr-log-${ts}.csv`, csv); let anyPhoto=false; for(let i=0;i<data.length;i++){ const r=data[i]; if(!r.photo || !/^data:image\\//.test(r.photo)) continue; const m2=r.photo.match(/^data:(image\\/[^;]+);base64,(.*)$/); if(!m2) continue; const b64=m2[2]; const bin=atob(b64); const u8=new Uint8Array(bin.length); for(let j=0;j<bin.length;j++) u8[j]=bin.charCodeAt(j); const ext=(m2[1]||'image/jpeg').split('/')[1]; const safe=(r.content||'').toString().slice(0,20).replace(/[^a-z0-9\\-_]+/gi,'_'); const name=`photos/${String(i+1).padStart(4,'0')}_${safe}.${ext}`; zip.file(name, u8); anyPhoto=true; } const blob=await zip.generateAsync({type:'blob'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`qr-log-bundle-${ts}.zip`; a.click(); URL.revokeObjectURL(a.href); setStatus(anyPhoto? 'Exported ZIP with CSV + photos.' : 'Exported ZIP (CSV only).'); }catch(err){ setStatus('ZIP export failed: '+(err.message||err)); } });

    document.getElementById('importFileBtn').addEventListener('click', function(){ const fi=document.getElementById('fileInput'); if(fi) fi.click(); });
    document.getElementById('fileInput').addEventListener('change', async function(e){ const file=e.target.files[0]; if(!file) return; const name=(file.name||'').toLowerCase(); if(name.slice(-4)==='.csv'){ const text=await file.text(); const rows=text.split(/\\r?\\n/).map(r=>r.split(/,(?=(?:[^\\\"]*\\\"[^\\\"]*\\\")*[^\\\"]*$)/)); const b=rows.slice(1); for(let i=0;i<b.length;i++){ const cols=b[i]; if(!cols.length||!cols[0])continue; upsert(cols[0].replace(/\\\\\\\"/g,'\\\"'), cols[1]||'qr_code', cols[2]||'import'); const last=data[0]; last.date=cols[3]||last.date; last.time=cols[4]||last.time; last.weight=cols[5]||''; last.photo=cols[6]||''; last.count=parseInt(cols[7]||'1',10); last.notes=(cols[8]||'').replace(/^\\\"|\\\"$/g,''); last.timestamp=cols[9]||last.timestamp; } } else { const buf=await file.arrayBuffer(); const wb=XLSX.read(buf,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const rows2=XLSX.utils.sheet_to_json(ws); for(let j=0;j<rows2.length;j++){ const o=rows2[j]; upsert(o['QR Content'], o['Format']||'qr_code', o['Source']||'import'); const last2=data[0]; last2.date=o['Date']||last2.date; last2.time=o['Time']||last2.time; last2.weight=o['Weight']||''; last2.photo=o['Photo']||''; last2.count=parseInt(o['Count']||'1',10); last2.notes=o['Notes']||''; last2.timestamp=o['Timestamp']||last2.timestamp; } } save(); render(); setStatus('Imported data from file.'); e.target.value=''; });

    document.getElementById('clearBtn').addEventListener('click', function(){ if(!confirm('Clear all rows?')) return; data=[]; save(); render(); setStatus('Log cleared.'); });

    if(scaleModeSel){ scaleModeSel.addEventListener('change', ()=>{ scaleMode = scaleModeSel.value; }); }
    if(delayInput){ delayInput.addEventListener('change', ()=>{ const v=parseFloat(delayInput.value); delaySec = Math.max(0, Math.min(4, isNaN(v)?2:v)); delayInput.value = String(delaySec); }); }
    if(ocrToggleBtn && overlay){
      ocrToggleBtn.addEventListener('click', ()=>{
        ocrBoxEnabled = !ocrBoxEnabled;
        window.ocrBoxEnabledGlobal = ocrBoxEnabled; // keep global flag in sync for drawOCRBox
        overlay.style.pointerEvents = ocrBoxEnabled ? 'auto' : 'none';
        drawOCRBox();
      });
      overlay.addEventListener('mousedown', (e)=>{
        if(!ocrBoxEnabled) return;
        const r=overlay.getBoundingClientRect();
        const x=e.clientX-r.left, y=e.clientY-r.top;
        const bx=ocrBox.x*overlay.width, by=ocrBox.y*overlay.height, bw=ocrBox.w*overlay.width, bh=ocrBox.h*overlay.height;
        if(x>bx && x<bx+bw && y>by && y<by+bh){
          isDragging=true; dragOffset.x=x-bx; dragOffset.y=y-by;
        }
      });
      window.addEventListener('mousemove', (e)=>{
        if(!isDragging) return;
        const r=overlay.getBoundingClientRect();
        let x=e.clientX-r.left-dragOffset.x;
        let y=e.clientY-r.top-dragOffset.y;
        x=Math.max(0,Math.min(x, overlay.width-ocrBox.w*overlay.width));
        y=Math.max(0,Math.min(y, overlay.height-ocrBox.h*overlay.height));
        ocrBox.x = x/overlay.width; ocrBox.y = y/overlay.height;
        window.ocrBox = ocrBox;
        drawOCRBox();
      });
      window.addEventListener('mouseup', ()=>{ isDragging=false; });
    }
    if(connectHIDBtn){ connectHIDBtn.addEventListener('click', connectHID); }
    if(connectBLEBtn){ connectBLEBtn.addEventListener('click', connectBLE); }

    $('#permBtn').addEventListener('click', requestPermission);
    $('#startBtn').addEventListener('click', startFromSelection);
    $('#stopBtn').addEventListener('click', function(){ stop(); setStatus('Camera stopped.'); });
    $('#refreshBtn').addEventListener('click', enumerateCams);
    cameraSelect.addEventListener('change', startFromSelection);

    load(); render(); updatePerm(); enumerateCams(); showAndroidBanner();
    if(document.visibilityState==='visible') setStatus('Ready. Request Permission â†’ Start Camera.');
  })();

  function beep(){ try{ var a=new AudioContext(), o=a.createOscillator(), g=a.createGain(); o.type='square'; o.frequency.value=880; o.connect(g); g.connect(a.destination); g.gain.setValueAtTime(0.05,a.currentTime); o.start(); setTimeout(function(){o.stop(); a.close();},90);}catch(e){} }

  // ---- Scale/OCR helpers ----
  function scheduleCapture(id){ const ms = Math.round((window.delaySecGlobal||2)*1000); setTimeout(async ()=>{ try{ const row = (function(){ try{ const d = JSON.parse(localStorage.getItem('qrLoggerV1')||'[]'); return d.find(r=>r.id===id); }catch(e){ return null; } })(); if(!row){ return; } let weight=''; if(window.scaleModeGlobal==='ocr'){ weight = await captureOCRWeight(); } else if(window.scaleModeGlobal==='hid' || window.scaleModeGlobal==='ble'){ weight = window.lastKnownWeightGlobal || ''; } row.weight = weight; row.photo = await capturePhoto(); const list = JSON.parse(localStorage.getItem('qrLoggerV1')||'[]').map(r=>r.id===id?row:r); localStorage.setItem('qrLoggerV1', JSON.stringify(list)); document.querySelector('#status').textContent='Captured delayed weight/photo.'; const ev = new Event('storage'); window.dispatchEvent(ev); }catch(err){ console.warn('capture failed', err); } }, ms); }
  window.scaleModeGlobal='none'; window.delaySecGlobal=2; window.lastKnownWeightGlobal='';
  setInterval(()=>{ try{ const s=document.getElementById('scaleMode'); if(s) window.scaleModeGlobal=s.value; const d=document.getElementById('delaySec'); if(d) window.delaySecGlobal=parseFloat(d.value)||2; window.lastKnownWeightGlobal = window.__lastKnownWeight||''; }catch(e){} }, 500);

  async function ensureTesseract(){ if(window.Tesseract) return true; return await new Promise((res)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js'; s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s); }); }
  async function captureOCRWeight(){ const ok=await ensureTesseract(); if(!ok) return ''; const v=document.getElementById('video'); const w=v.videoWidth, h=v.videoHeight; if(!w||!h) return ''; const rx=Math.floor((window.ocrBox?.x||0.6)*w), ry=Math.floor((window.ocrBox?.y||0.65)*h), rw=Math.floor((window.ocrBox?.w||0.35)*w), rh=Math.floor((window.ocrBox?.h||0.25)*h); const c=document.createElement('canvas'); c.width=rw; c.height=rh; const cctx=c.getContext('2d', {willReadFrequently:true}); cctx.drawImage(v, rx, ry, rw, rh, 0, 0, rw, rh); const { data:{ text } } = await Tesseract.recognize(c, 'eng', { tessedit_char_whitelist:'0123456789.-', classify_bln_numeric_mode:1 }); const m=(text||'').replace(/[, ]/g,'').match(/-?\\d+(?:\\.\\d+)?/); return m?m[0]:''; }
  async function capturePhoto(){ const v=document.getElementById('video'); const w=v.videoWidth, h=v.videoHeight; if(!w||!h) return ''; const c=document.createElement('canvas'); c.width=w; c.height=h; const cx=c.getContext('2d'); cx.drawImage(v,0,0,w,h); return c.toDataURL('image/jpeg',0.8); }

  function drawOCRBox(){ try{ const overlay=document.getElementById('overlay'); const octx=overlay.getContext('2d'); octx.clearRect(0,0,overlay.width,overlay.height); if(!window.ocrBoxEnabledGlobal) return; const bx=(window.ocrBox?.x||0.6)*overlay.width, by=(window.ocrBox?.y||0.65)*overlay.height, bw=(window.ocrBox?.w||0.35)*overlay.width, bh=(window.ocrBox?.h||0.25)*overlay.height; octx.strokeStyle='#22c55e'; octx.lineWidth=3; octx.setLineDash([8,6]); octx.strokeRect(bx,by,bw,bh); octx.setLineDash([]); octx.fillStyle='rgba(34,197,94,0.08)'; octx.fillRect(bx,by,bw,bh); }catch(e){} }
  window.ocrBoxEnabledGlobal=false; window.ocrBox={x:0.6,y:0.65,w:0.35,h:0.25};

  async function connectHID(){ try{ if(!('hid' in navigator)) { document.querySelector('#status').textContent='WebHID not supported.'; return; } const devices = await navigator.hid.requestDevice({ filters: [] }); if(!devices.length){ document.querySelector('#status').textContent='No HID device chosen.'; return; } const dev=devices[0]; await dev.open(); dev.oninputreport = e => { try{ const dv=new DataView(e.data.buffer); let ascii=''; for(let i=0;i<e.data.byteLength;i++){ const ch=e.data.getUint8(i); if(ch>=32 && ch<=126) ascii += String.fromCharCode(ch); } const m = ascii.replace(/[, ]/g,'').match(/-?\\d+(?:\\.\\d+)?/); if(m){ window.__lastKnownWeight=m[0]; return; } if(dv.byteLength>=4){ const grams=dv.getInt16(2,true); if(!Number.isNaN(grams)) window.__lastKnownWeight = String(grams/1000); } }catch(err){} }; document.querySelector('#status').textContent='HID connected: '+(dev.productName||'Scale'); }catch(err){ document.querySelector('#status').textContent='HID connect failed: '+err.message; } }
  async function connectBLE(){ try{ if(!('bluetooth' in navigator)){ document.querySelector('#status').textContent='WebBluetooth not supported.'; return; } let dev = await navigator.bluetooth.requestDevice({ acceptAllDevices:true, optionalServices:[0x181D, '6e400001-b5a3-f393-e0a9-e50e24dcca9e'] }); const server = await dev.gatt.connect(); try{ const svc = await server.getPrimaryService(0x181D); const ch = await svc.getCharacteristic(0x2A9D); await ch.startNotifications(); ch.addEventListener('characteristicvaluechanged', ev=>{ const dv=ev.target.value; if(dv.byteLength>=4){ const flags=dv.getUint8(0); const unitLbs = (flags & 0x01)!==0; const weight = dv.getUint16(1, true) / 200; window.__lastKnownWeight = unitLbs ? String((weight*0.45359237).toFixed(3)) : String(weight.toFixed(3)); } }); document.querySelector('#status').textContent='BLE: Weight Scale connected'; return; }catch(_e){} try{ const nus = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e'); const rx = await nus.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e'); await rx.startNotifications(); rx.addEventListener('characteristicvaluechanged', ev=>{ const v=new TextDecoder().decode(ev.target.value||new DataView(new ArrayBuffer(0))); const m=v.replace(/[, ]/g,'').match(/-?\\d+(?:\\.\\d+)?/); if(m) window.__lastKnownWeight=m[0]; }); document.querySelector('#status').textContent='BLE: UART connected'; }catch(err){ document.querySelector('#status').textContent='BLE connect failed: '+err.message; } }catch(err){ document.querySelector('#status').textContent='BLE connect failed: '+err.message; } }
  </script>
</body>
</html>
